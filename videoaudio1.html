<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®‰å…¨ç‰ˆ é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
<style>
body{font-family:"Segoe UI",sans-serif;text-align:center;padding:30px;background:#fafafa;}
input[type=text]{width:80%;padding:10px;margin:8px 0;border-radius:5px;border:1px solid #ccc;}
video{width:80%;max-width:800px;margin-top:20px;background:#000;border-radius:10px;}
button{padding:10px 20px;margin:10px;font-size:16px;border-radius:5px;border:none;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
.slider-container{margin-top:20px;width:80%;max-width:600px;margin:auto;text-align:center;}
input[type=range]{width:100%;}
.label{font-weight:bold;}
#driftDisplay{margin-top:10px;font-weight:bold;font-size:18px;}
</style>
</head>
<body>

<h2>ğŸ¬ å®‰å…¨ç‰ˆ é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

<div>
<input type="text" id="videoURL" placeholder="å‹•ç”»URL"><br>
<input type="text" id="audioURL" placeholder="éŸ³å£°URL"><br>
<button onclick="loadMedia()">èª­ã¿è¾¼ã¿</button>
<button onclick="playMedia()">â–¶ å†ç”Ÿ</button>
<button onclick="pauseMedia()">â¸ åœæ­¢</button>
</div>

<div class="slider-container">
<p class="label">ğŸšï¸ éŸ³å£°é…å»¶èª¿æ•´ï¼š<span id="delayValue">0.00</span> ç§’</p>
<input type="range" id="delaySlider" min="-1" max="1" value="0" step="0.05" oninput="updateDelay(this.value)">
</div>

<div class="slider-container">
<p class="label">ğŸ”Š éŸ³é‡èª¿æ•´ï¼š<span id="volumeValue">100</span>%</p>
<input type="range" id="volumeSlider" min="0" max="100" value="100" step="1" oninput="updateVolume(this.value)">
</div>

<div class="slider-container">
<p class="label">â±ï¸ å†ç”Ÿé€Ÿåº¦ï¼š<span id="speedValue">1.00</span>x</p>
<input type="range" id="speedSlider" min="0.25" max="2" value="1" step="0.01" oninput="updateSpeed(this.value)">
</div>

<div class="slider-container">
<p class="label">âš™ï¸ ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£å¼·åº¦ï¼š<span id="strengthValue">1.00</span></p>
<input type="range" id="strengthSlider" min="0" max="10" value="1" step="0.01" oninput="updateStrength(this.value)">
</div>

<div style="margin-top:20px;">
<label>
<input type="checkbox" id="loopToggle" onchange="toggleLoop(this.checked)">
ğŸ” ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
</label>
</div>

<div id="driftDisplay">ã‚ºãƒ¬: 0.00 ç§’</div>

<div>
<video id="video" controls></video>
<audio id="audio" crossorigin="anonymous"></audio>
</div>

<script src="https://cdn.jsdelivr.net/gh/also/soundtouch-js/dist/soundtouch.min.js"></script>
<script>
const video = document.getElementById("video");
const audio = document.getElementById("audio");
const delayDisplay = document.getElementById("delayValue");
const volumeDisplay = document.getElementById("volumeValue");
const speedDisplay = document.getElementById("speedValue");
const driftDisplay = document.getElementById("driftDisplay");
const strengthDisplay = document.getElementById("strengthValue");

let syncInterval;
let audioDelay = 0;
let isLooping = false;
let baseSpeed = 1.0;
let driftStrength = 1.0;
let userDriftStrength = 1.0; // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå€¤

// Web Audio API
let audioCtx, sourceNode, gainNode, st, soundTouchNode;

function setupAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);
    gainNode = audioCtx.createGain();
    sourceNode.connect(gainNode).connect(audioCtx.destination);

    // SoundTouch.js
    st = new soundtouch.SoundTouch(audioCtx.sampleRate);
    soundTouchNode = {soundTouch: st}; // placeholder
  }
}

function loadMedia() {
  const videoURL = document.getElementById("videoURL").value.trim();
  const audioURL = document.getElementById("audioURL").value.trim();
  if(!videoURL || !audioURL){alert("å‹•ç”»ã¨éŸ³å£°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;}
  video.src = videoURL;
  audio.src = audioURL;
  video.load();
  audio.load();
  clearInterval(syncInterval);
  driftDisplay.textContent = "ã‚ºãƒ¬: 0.00 ç§’";
  driftDisplay.style.color = "green";
  setupAudioContext();
}

function playMedia() {
  audioCtx.resume();
  audio.currentTime = Math.max(0, video.currentTime + audioDelay);
  video.play();
  audio.play();

  syncInterval = setInterval(()=>{
    const diff = (video.currentTime + audioDelay) - audio.currentTime;

    // ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£ï¼ˆéŸ³è³ªç¶­æŒï¼‰
    if(Math.abs(diff)<0.05){
      audio.playbackRate = baseSpeed;
    } else {
      let correction = 1 + diff*0.05*driftStrength;
      correction = Math.max(0.95, Math.min(1.05, correction));
      const adjustedSpeed = baseSpeed * correction;
      audio.playbackRate = Math.max(0.25, Math.min(2.0, adjustedSpeed));
      audio.preservesPitch = true;
    }

    // ã‚ºãƒ¬è¡¨ç¤º
    driftDisplay.textContent = `ã‚ºãƒ¬: ${diff.toFixed(2)} ç§’`;
    const absDiff=Math.abs(diff);
    driftDisplay.style.color = absDiff<0.05?"green":absDiff<0.2?"orange":"red";
  },100);
}

function pauseMedia(){
  video.pause();
  audio.pause();
  clearInterval(syncInterval);
}

video.addEventListener("seeked", ()=>{audio.currentTime = Math.max(0, video.currentTime + audioDelay);});
video.addEventListener("pause", ()=>{audio.pause();});
video.addEventListener("play", ()=>{audio.play();});
video.addEventListener("ended", ()=>{
  clearInterval(syncInterval);
  if(isLooping){video.currentTime=0; audio.currentTime=0; playMedia();}
  else {audio.pause();}
});

// å‹•ç”»é€Ÿåº¦å¤‰æ›´æ™‚ã«éŸ³å£°ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ»ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£ã‚’é€£å‹•
video.addEventListener("ratechange", () => {
    baseSpeed = video.playbackRate;
    audio.playbackRate = baseSpeed;

    // é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºæ›´æ–°
    const speedSlider = document.getElementById("speedSlider");
    speedSlider.value = baseSpeed;
    speedDisplay.textContent = baseSpeed.toFixed(2);

    // ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£ã‚’å®‰å…¨ç¯„å›²ã§è‡ªå‹•èª¿æ•´
    driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed));
    strengthDisplay.textContent = driftStrength.toFixed(2);
});

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ›´æ–°é–¢æ•°
function updateDelay(v){audioDelay=parseFloat(v); delayDisplay.textContent=v;}
function updateVolume(v){gainNode.gain=parseInt(v)/100; volumeDisplay.textContent=v;}
function updateSpeed(v){
    baseSpeed=parseFloat(v);
    audio.playbackRate = baseSpeed;
    video.playbackRate = baseSpeed;
    speedDisplay.textContent=parseFloat(v).toFixed(2);

    // ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£ã‚‚å®‰å…¨ç¯„å›²ã§é€£å‹•
    driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed));
    strengthDisplay.textContent = driftStrength.toFixed(2);
}
function toggleLoop(c){isLooping=c; video.loop=c;}
function updateStrength(v){
    userDriftStrength = parseFloat(v);
    // å®‰å…¨ç¯„å›²ã§åæ˜ 
    driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed));
    strengthDisplay.textContent = driftStrength.toFixed(2);
}
</script>
</body>
</html>
