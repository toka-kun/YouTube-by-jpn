<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ â€” å®Œå…¨ç‰ˆ</title>
<style>
:root{--primary:#007bff;--primary-dark:#0056b3;--bg:#fafafa}
html,body{height:100%}
body{font-family:"Segoe UI",system-ui,Arial,sans-serif;background:var(--bg);color:#111;margin:0;padding:18px;display:flex;justify-content:center;align-items:flex-start}
.app{width:100%;max-width:980px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{font-size:18px;margin:0}
.controls{margin-top:12px;display:grid;gap:10px}
.row{display:flex;gap:8px;align-items:center}
input[type=text]{flex:1;padding:9px;border-radius:6px;border:1px solid #ccc}
button{padding:8px 12px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
button.secondary{background:#6c757d}
button.ghost{background:transparent;color:var(--primary);border:1px solid #ddd}
button:focus{outline:3px solid rgba(0,123,255,0.25)}
.slider-row{display:flex;align-items:center;gap:10px}
input[type=range]{flex:1}
.video-wrap{margin-top:14px}
video{width:100%;border-radius:8px;background:#000}
.status{margin-top:10px;font-size:14px}
.presets{display:flex;gap:6px;flex-wrap:wrap}
.preset-btn{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
.dropzone{margin-top:8px;padding:12px;border:2px dashed #ccc;border-radius:8px;text-align:center;color:#666}
.small{font-size:13px;color:#555}
.tooltip{font-size:12px;color:#666}
kbd{background:#eee;border-radius:4px;padding:2px 6px;font-size:12px;border:1px solid #ddd}
.bad{color:crimson}
.good{color:green}

/* touch target improvement */
@media (pointer: coarse) {
  input[type=range]{height: 28px}
  button{padding:12px 16px}
}
</style>
</head>
<body>
<div class="app" aria-label="é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ å®Œå…¨ç‰ˆ">
  <div class="header">
    <h1>ğŸ¬ é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ â€” å®Œå…¨ç‰ˆ</h1>
    <div class="tooltip" id="helpTooltip">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰: <kbd>Space</kbd>=å†ç”Ÿ/åœæ­¢ <kbd>&larr;&rarr;</kbd>=5ç§’ã‚·ãƒ¼ã‚¯ <kbd>&uarr;&darr;</kbd>=éŸ³é‡ Â±5 <kbd>&lt;</kbd>/<kbd>&gt;</kbd>=é€Ÿåº¦ Â±0.05</div>
  </div>

  <div class="controls" aria-live="polite">
    <div class="row">
      <label for="videoURL" class="small" style="margin-right:8px">å‹•ç”» URL</label>
      <input id="videoURL" type="text" placeholder="https://... ã‚‚ã—ãã¯ã“ã“ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—" aria-label="å‹•ç”»URLå…¥åŠ›">
      <button id="btnLoad" title="å‹•ç”»ã¨éŸ³å£°ã‚’èª­ã¿è¾¼ã¿">èª­ã¿è¾¼ã¿</button>
      <button id="btnPlay" title="å†ç”Ÿ (Space)" aria-pressed="false">â–¶ å†ç”Ÿ</button>
      <button id="btnPause" title="åœæ­¢" aria-pressed="false">â¸ åœæ­¢</button>
    </div>

    <div class="row">
      <label for="audioURL" class="small" style="margin-right:8px">éŸ³å£° URL</label>
      <input id="audioURL" type="text" placeholder="https://... ã¾ãŸã¯ã“ã“ã¸éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—" aria-label="éŸ³å£°URLå…¥åŠ›">
      <button id="btnSyncNow" class="ghost" title="æ‰‹å‹•ã§éŸ³å£°ã®å†åŒæœŸ">åŒæœŸåˆã‚ã›</button>
    </div>

    <div id="dropzone" class="dropzone" tabindex="0" aria-label="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦èª­ã¿è¾¼ã¿">éŸ³å£°/å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>

    <div class="slider-row" aria-label="éŸ³å£°é…å»¶">
      <label class="small" for="delaySlider">é…å»¶ï¼ˆç§’ï¼‰ <span id="delayValue">0.00</span></label>
      <input id="delaySlider" type="range" min="-1" max="1" step="0.01" value="0" aria-label="éŸ³å£°é…å»¶ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="éŸ³é‡">
      <label class="small" for="volumeSlider">éŸ³é‡ <span id="volumeValue">100%</span></label>
      <input id="volumeSlider" type="range" min="0" max="100" step="1" value="100" aria-label="éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="å†ç”Ÿé€Ÿåº¦">
      <label class="small" for="speedSlider">é€Ÿåº¦ <span id="speedValue">1.00x</span></label>
      <input id="speedSlider" type="range" min="0.25" max="2" step="0.01" value="1" aria-label="é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£å¼·åº¦">
      <label class="small">è£œæ­£ <span id="strengthValue">1.00</span></label>
      <input id="strengthSlider" type="range" min="0" max="10" step="0.01" value="1" aria-label="è£œæ­£å¼·åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="row">
      <label><input id="loopToggle" type="checkbox" aria-label="ãƒ«ãƒ¼ãƒ—åˆ‡æ›¿"> ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</label>
      <label style="margin-left:8px"><input id="autoSyncToggle" type="checkbox" checked> è‡ªå‹•åŒæœŸï¼ˆã‚ªãƒ³/ã‚ªãƒ•ï¼‰</label>
    </div>

    <div class="row">
      <div class="presets" aria-label="ãƒ—ãƒªã‚»ãƒƒãƒˆ">
        <button id="savePresetBtn" class="preset-btn" title="ç¾åœ¨ã®è¨­å®šã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜">ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</button>
        <button id="loadPresetBtn" class="preset-btn" title="ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿">ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿</button>
        <button id="exportPresetBtn" class="preset-btn" title="ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importPresetBtn" class="preset-btn" title="ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="resetPresetsBtn" class="preset-btn" title="ã™ã¹ã¦ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤">ãƒ—ãƒªã‚»ãƒƒãƒˆå…¨å‰Šé™¤</button>
      </div>
    </div>

    <div id="presetList" class="small"></div>

    <div id="driftDisplay" class="status" aria-live="polite">ã‚ºãƒ¬: 0.000 ç§’</div>
    <div id="info" class="small" role="status" aria-live="polite"></div>
  </div>

  <div class="video-wrap">
    <video id="video" controls crossorigin="anonymous" aria-label="å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"></video>
    <audio id="audio" crossorigin="anonymous" style="display:none"></audio>
  </div>
</div>

<script>
/* ======= å®Œå…¨ç‰ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆCORS é–¢é€£ä»¥å¤–ã®æ”¹å–„ã‚’ã™ã¹ã¦é©ç”¨ï¼‰ ======= */

/* ----- DOM ----- */
const video = document.getElementById('video');
const audio = document.getElementById('audio');
const btnLoad = document.getElementById('btnLoad');
const btnPlay = document.getElementById('btnPlay');
const btnPause = document.getElementById('btnPause');
const btnSyncNow = document.getElementById('btnSyncNow');

const videoURL = document.getElementById('videoURL');
const audioURL = document.getElementById('audioURL');
const dropzone = document.getElementById('dropzone');

const delaySlider = document.getElementById('delaySlider');
const volumeSlider = document.getElementById('volumeSlider');
const speedSlider = document.getElementById('speedSlider');
const strengthSlider = document.getElementById('strengthSlider');
const loopToggle = document.getElementById('loopToggle');
const autoSyncToggle = document.getElementById('autoSyncToggle');

const delayValue = document.getElementById('delayValue');
const volumeValue = document.getElementById('volumeValue');
const speedValue = document.getElementById('speedValue');
const strengthValue = document.getElementById('strengthValue');
const driftDisplay = document.getElementById('driftDisplay');
const info = document.getElementById('info');

const savePresetBtn = document.getElementById('savePresetBtn');
const loadPresetBtn = document.getElementById('loadPresetBtn');
const exportPresetBtn = document.getElementById('exportPresetBtn');
const importPresetBtn = document.getElementById('importPresetBtn');
const resetPresetsBtn = document.getElementById('resetPresetsBtn');
const presetList = document.getElementById('presetList');

/* ----- çŠ¶æ…‹ ----- */
let audioCtx = null, sourceNode = null, gainNode = null;
let rafId = null;
let audioDelay = 0.0;
let baseSpeed = 1.0;
let userDriftStrength = 1.0;
let driftStrength = 1.0;
let isLooping = false;
let isSyncing = false;
let currentObjectURL = null;

/* ----- å®šæ•° ----- */
const PRESET_KEY = 'ts_player_presets_v1';
const PRESET_SCHEMA_VERSION = 1;

/* ======================
   ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ï¼ˆlocalStorageï¼‰
   ====================== */
function loadPresets(){
  try {
    const raw = localStorage.getItem(PRESET_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch(e){ console.warn('ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¤±æ•—', e); return {}; }
}
function savePresets(obj){
  try {
    localStorage.setItem(PRESET_KEY, JSON.stringify(obj));
  } catch(e) {
    console.warn('ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
  }
}
function addPreset(name, cfg){
  const ps = loadPresets();
  if(ps[name] && !confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${name}" ã¯æ—¢ã«ã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
  ps[name] = cfg;
  savePresets(ps);
  renderPresetList();
}
function removePreset(name){
  const ps = loadPresets();
  delete ps[name];
  savePresets(ps);
  renderPresetList();
}
function renderPresetList(){
  const ps = loadPresets();
  if(Object.keys(ps).length === 0){
    presetList.textContent = 'ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
    return;
  }
  presetList.innerHTML = '';
  for(const k of Object.keys(ps)){
    const b = document.createElement('button');
    b.textContent = k;
    b.className = 'preset-btn';
    b.title = 'ã‚¯ãƒªãƒƒã‚¯ã§èª­ã¿è¾¼ã¿ã€‚å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤';
    b.addEventListener('click', ()=>applyPreset(ps[k]));
    b.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); if(confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${k}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) removePreset(k); });
    presetList.appendChild(b);
  }
}
renderPresetList();

/* ======= ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³æŒ™å‹•ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆç­‰ï¼‰ ======= */
savePresetBtn.addEventListener('click', ()=>{
  const name = prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: è¬›ç¾©ãƒ¢ãƒ¼ãƒ‰ï¼‰');
  if(!name) return;
  const cfg = currentConfig();
  addPreset(name, cfg);
  showInfo('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + name);
});
loadPresetBtn.addEventListener('click', ()=>{
  const ps = loadPresets();
  const keys = Object.keys(ps);
  if(keys.length === 0){ alert('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const name = prompt('èª­ã¿è¾¼ã‚€ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nå€™è£œ: ' + keys.join(', '));
  if(!name) return;
  if(!ps[name]){ alert('ãã®ãƒ—ãƒªã‚»ãƒƒãƒˆã¯å­˜åœ¨ã—ã¾ã›ã‚“'); return; }
  applyPreset(ps[name]);
  showInfo('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ: ' + name);
});
exportPresetBtn.addEventListener('click', ()=>{
  const ps = loadPresets();
  const blob = new Blob([JSON.stringify(ps, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ts_presets.json'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});
importPresetBtn.addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = ()=> {
    const f = inp.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      try{
        const data = JSON.parse(reader.result);
        if(typeof data !== 'object' || data === null){ throw new Error('ãƒ«ãƒ¼ãƒˆã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'); }
        // ãƒãƒ¼ã‚¸ + ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æ¤œæŸ»
        const ps = loadPresets();
        let imported = 0;
        for(const [k,v] of Object.entries(data)){
          const validated = validatePresetObject(v);
          if(validated) { ps[k] = validated; imported++; }
        }
        savePresets(ps);
        renderPresetList();
        showInfo(`ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ${imported} ä»¶ï¼‰`);
      }catch(e){ alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™: ' + (e && e.message ? e.message : e)); }
    };
    reader.readAsText(f);
  };
  inp.click();
});
resetPresetsBtn.addEventListener('click', ()=>{
  if(confirm('ã™ã¹ã¦ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(PRESET_KEY); renderPresetList(); showInfo('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ'); }
});

/* ----- ãƒ—ãƒªã‚»ãƒƒãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ----- */
function validatePresetObject(obj){
  if(!obj || typeof obj !== 'object') return null;
  const valid = {};
  if(typeof obj.delay === 'number') valid.delay = Math.max(-10, Math.min(10, obj.delay));
  if(typeof obj.volume === 'number') valid.volume = Math.max(0, Math.min(100, Math.round(obj.volume)));
  if(typeof obj.speed === 'number') valid.speed = Math.max(0.25, Math.min(2, obj.speed));
  if(typeof obj.strength === 'number') valid.strength = Math.max(0, Math.min(10, obj.strength));
  if(typeof obj.loop === 'boolean') valid.loop = obj.loop;
  return Object.keys(valid).length ? valid : null;
}

/* ======= è¨­å®šã®å–å¾—ã¨é©ç”¨ ======= */
function currentConfig(){
  return {
    version: PRESET_SCHEMA_VERSION,
    delay: parseFloat(delaySlider.value),
    volume: parseInt(volumeSlider.value),
    speed: parseFloat(speedSlider.value),
    strength: parseFloat(strengthSlider.value),
    loop: loopToggle.checked
  };
}
function applyPreset(cfg){
  if(typeof cfg.delay === 'number') { delaySlider.value = cfg.delay; audioDelay = cfg.delay; delayValue.textContent = cfg.delay.toFixed(2); }
  if(typeof cfg.volume === 'number') { volumeSlider.value = cfg.volume; applyVolume(cfg.volume); }
  if(typeof cfg.speed === 'number') { speedSlider.value = cfg.speed; baseSpeed = cfg.speed; video.playbackRate = baseSpeed; audio.playbackRate = baseSpeed; speedValue.textContent = baseSpeed.toFixed(2) + 'x'; }
  if(typeof cfg.strength === 'number') { strengthSlider.value = cfg.strength; userDriftStrength = cfg.strength; driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed)); strengthValue.textContent = driftStrength.toFixed(2); }
  if(typeof cfg.loop === 'boolean') { loopToggle.checked = cfg.loop; video.loop = cfg.loop; }
}

/* ======= ãƒ˜ãƒ«ãƒ‘ãƒ¼ ======= */
function showInfo(msg, isErr=false){
  info.textContent = msg;
  info.className = isErr ? 'small bad' : 'small';
}

/* ======= AudioContext å®‰å…¨åŒ–ï¼ˆé‡è¤‡ä½œæˆé˜²æ­¢ãƒ»å†æ¥ç¶šå‡¦ç†ï¼‰ ======= */
function ensureAudioContext(){
  try {
    if(!audioCtx || audioCtx.state === 'closed'){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    // resume ã¯éåŒæœŸã ãŒå‘¼ã‚“ã§ãŠã
    if(audioCtx.state === 'suspended'){
      audioCtx.resume().catch(()=>{ /* ignore */ });
    }

    // æ¥ç¶šã‚’ï¼ˆå†ï¼‰ä½œæˆã™ã‚‹ï¼šæ—¢å­˜ã® sourceNode ãŒã‚ã‚Œã°åˆ‡æ–­ã™ã‚‹
    if(sourceNode){
      try{ sourceNode.disconnect(); }catch(e){}
      sourceNode = null;
    }
    if(gainNode){
      try{ gainNode.disconnect(); }catch(e){}
      gainNode = null;
    }

    // createMediaElementSource ã¯åŒä¸€ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã«å¯¾ã—ã¦è¤‡æ•°ä½œæˆã§ããªã„ãŸã‚ã€
    // ä¾‹å¤–ãŒå‡ºãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ï¼ˆaudio.volumeï¼‰
    try {
      sourceNode = audioCtx.createMediaElementSource(audio);
      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(volumeSlider.value)/100 || 1.0;
      sourceNode.connect(gainNode).connect(audioCtx.destination);
      showInfo('AudioContext åˆæœŸåŒ–');
    } catch(e) {
      // createMediaElementSource ãŒå¤±æ•—ã™ã‚‹å ´åˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ãƒ»CORSç­‰ï¼‰
      sourceNode = null;
      gainNode = null;
      audio.volume = parseFloat(volumeSlider.value)/100 || 1.0;
      showInfo('AudioContext ã‚’ä½¿ç”¨ã§ããªã„ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆvolume å›ºå®šï¼‰', true);
    }
    return audioCtx;
  } catch(e) {
    console.error('AudioContext åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
    showInfo('AudioContext åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
    return null;
  }
}

/* ======= ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ»ObjectURL ã®ç®¡ç† ======= */
function revokeCurrentObjectURL(){
  if(currentObjectURL){
    try { URL.revokeObjectURL(currentObjectURL); } catch(e){}
    currentObjectURL = null;
  }
}
function setMediaFromFile(file){
  if(!file) return;
  revokeCurrentObjectURL();
  currentObjectURL = URL.createObjectURL(file);
  if(file.type.startsWith('video/')){
    video.src = currentObjectURL;
    showInfo('ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } else if(file.type.startsWith('audio/')){
    audio.src = currentObjectURL;
    showInfo('ãƒ­ãƒ¼ã‚«ãƒ«éŸ³å£°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } else {
    // æœªçŸ¥ã‚¿ã‚¤ãƒ—ã¯ audio ã«å…¥ã‚Œã¦ã¿ã‚‹
    audio.src = currentObjectURL;
    showInfo('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆã‚¿ã‚¤ãƒ—:' + file.type + ')');
  }
  // metadata ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãŠã
  // note: video.load() ã¯éåŒæœŸã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  try { video.load(); audio.load(); } catch(e){}
}

/* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— */
['dragenter','dragover'].forEach(evt=>{
  dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.style.borderColor = '#007bff'; dropzone.style.background = '#f6fbff'; });
});
['dragleave','drop'].forEach(evt=>{
  dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.style.borderColor = '#ccc'; dropzone.style.background = ''; });
});
dropzone.addEventListener('drop', (e)=>{
  e.preventDefault();
  const dt = e.dataTransfer;
  if(dt && dt.files && dt.files.length){
    handleFiles(dt.files);
  } else {
    showInfo('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
  }
});
dropzone.addEventListener('click', ()=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='audio/*,video/*'; inp.onchange = ()=> handleFiles(inp.files); inp.click(); });
dropzone.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') { dropzone.click(); } });

function handleFiles(files){
  const f = files[0];
  if(!f) return;
  setMediaFromFile(f);
}

/* ======= å†ç”Ÿ / åŒæœŸé–¢ä¿‚ ======= */
btnLoad.addEventListener('click', ()=>{
  const v = videoURL.value.trim();
  const a = audioURL.value.trim();
  if(v) { video.src = v; }
  if(a) { audio.src = a; }
  driftDisplay.textContent = 'ã‚ºãƒ¬: 0.000 ç§’';
  driftDisplay.style.color = 'green';
  showInfo('èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚CORSã«æ³¨æ„ã€‚'); // CORS æ³¨æ„ã¯æ®‹ã™ãŒå‡¦ç†ã¯é™¤å¤–
});

/* å†ç”Ÿå‰ã« loadedmetadata ãŒæƒã£ã¦ã„ã‚‹ã‹å¾…ã¤ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function waitForMetadata(el, timeoutMs = 3000){
  return new Promise((resolve, reject)=>{
    if(isFinite(el.duration) && !isNaN(el.duration)) return resolve();
    let done = false;
    const onLoaded = ()=>{ if(done) return; done = true; el.removeEventListener('loadedmetadata', onLoaded); resolve(); };
    el.addEventListener('loadedmetadata', onLoaded);
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šå¼·åˆ¶çš„ã«è§£æ”¾
    const to = setTimeout(()=>{ if(done) return; done = true; el.removeEventListener('loadedmetadata', onLoaded); resolve(); }, timeoutMs);
  });
}

btnPlay.addEventListener('click', async ()=>{
  ensureAudioContext();
  // resume audio context if suspended
  try{ if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume(); }catch(e){}

  // metadata ã‚’å¾…ã¤ï¼ˆçŸ­ã‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
  await Promise.all([waitForMetadata(video, 4000), waitForMetadata(audio, 4000)]);

  // å®‰å…¨ã« currentTime ã‚’ã‚»ãƒƒãƒˆ
  try {
    const base = isFinite(video.currentTime) ? video.currentTime : 0;
    audio.currentTime = Math.max(0, base + audioDelay);
  } catch(e) { console.warn('currentTime è¨­å®šå¤±æ•—', e); }

  // Play ä¸¡æ–¹ã«å¯¾ã—ã¦å†ç”Ÿè¦æ±‚ã‚’è¡Œã„ã€å¤±æ•—ã¯ç„¡è¦–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ï¼‰
  try{ await Promise.all([video.play().catch(()=>{}), audio.play().catch(()=>{})]); }catch(e){ console.warn('play failed', e); }
  startSyncLoop();

  // ARIA æ›´æ–°
  btnPlay.setAttribute('aria-pressed', 'true');
  btnPause.setAttribute('aria-pressed', 'false');
  showInfo('å†ç”Ÿä¸­');
});
btnPause.addEventListener('click', ()=>{
  video.pause(); audio.pause(); stopSyncLoop();
  btnPlay.setAttribute('aria-pressed', 'false');
  btnPause.setAttribute('aria-pressed', 'true');
  showInfo('åœæ­¢ã—ã¾ã—ãŸ');
});
btnSyncNow.addEventListener('click', ()=>{
  try {
    audio.currentTime = Math.max(0, (isFinite(video.currentTime) ? video.currentTime : 0) + audioDelay);
    showInfo('æ‰‹å‹•ã§åŒæœŸã—ã¾ã—ãŸ');
  } catch(e) {
    showInfo('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  }
});

/* ======= ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ ======= */
delaySlider.addEventListener('input', (e)=>{ audioDelay = parseFloat(e.target.value); delayValue.textContent = audioDelay.toFixed(2); });
volumeSlider.addEventListener('input', (e)=>{ const v = parseInt(e.target.value); volumeValue.textContent = v + '%'; applyVolume(v); });
function applyVolume(v){
  if(gainNode && audioCtx){ try{ gainNode.gain.linearRampToValueAtTime(v/100, audioCtx.currentTime + 0.05); }catch(e){ audio.volume = v/100; } }
  else { audio.volume = v/100; }
}
speedSlider.addEventListener('input', (e)=>{ baseSpeed = parseFloat(e.target.value); speedValue.textContent = baseSpeed.toFixed(2) + 'x'; video.playbackRate = baseSpeed; audio.playbackRate = baseSpeed; driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed)); strengthValue.textContent = driftStrength.toFixed(2); });
strengthSlider.addEventListener('input', (e)=>{ userDriftStrength = parseFloat(e.target.value); driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed)); strengthValue.textContent = driftStrength.toFixed(2); });
loopToggle.addEventListener('change', (e)=>{ isLooping = e.target.checked; video.loop = isLooping; });

/* ======= åŒæœŸãƒ«ãƒ¼ãƒ—ï¼ˆrequestAnimationFrame + ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰ ======= */
let lastUpdateTime = null;
let smoothedRate = 1.0;

function startSyncLoop(){
  if(isSyncing) return;
  isSyncing = true;
  lastUpdateTime = performance.now();
  smoothedRate = baseSpeed;

  // ã‚·ãƒ¼ã‚¯ã‚„çµ‚äº†æ™‚ã«ãƒ«ãƒ¼ãƒ—ã‚’ä¸€æ™‚åœæ­¢/å†é–‹ã™ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©
  function onSeeking(){ stopSyncLoop(false); /* false: å®Œå…¨åœæ­¢ã›ãšãƒ•ãƒ©ã‚°ã ã‘ */ }
  function onSeeked(){ if(!video.paused) startSyncLoop(); }
  function onEnded(){ stopSyncLoop(true); }

  // attach handlers (ensure not duplicated)
  video.removeEventListener('seeking', onSeeking);
  video.removeEventListener('seeked', onSeeked);
  video.removeEventListener('ended', onEnded);
  video.addEventListener('seeking', onSeeking);
  video.addEventListener('seeked', onSeeked);
  video.addEventListener('ended', onEnded);

  function loop(now){
    if(!isSyncing) { return; }

    // è‡ªå‹•åŒæœŸãŒã‚ªãƒ•ãªã‚‰è¡¨ç¤ºæ›´æ–°ã®ã¿
    if(!autoSyncToggle.checked){
      driftDisplay.textContent = `ã‚ºãƒ¬: ${((isFinite(video.currentTime)?video.currentTime:0) + audioDelay - (isFinite(audio.currentTime)?audio.currentTime:0)).toFixed(3)} ç§’ (è‡ªå‹•åŒæœŸã‚ªãƒ•)`;
      rafId = requestAnimationFrame(loop);
      return;
    }

    const videoTime = isFinite(video.currentTime) ? video.currentTime : 0;
    const audioTime = isFinite(audio.currentTime) ? audio.currentTime : 0;
    const diff = (videoTime + audioDelay) - audioTime;

    // å°ã•ã‚ã®ä¿‚æ•°ã§ã‚†ã£ãã‚Šè£œæ­£ï¼ˆå®‰å®šæ€§å„ªå…ˆï¼‰
    const k = 0.05 * Math.min(1, driftStrength/2);
    let targetFactor = 1 + diff * k;
    targetFactor = Math.max(0.95, Math.min(1.05, targetFactor));
    const targetRate = baseSpeed * targetFactor;

    const dt = Math.min(0.1, (now - lastUpdateTime) / 1000);
    const smoothFactor = 1 - Math.exp(-10 * dt);
    smoothedRate += (targetRate - smoothedRate) * smoothFactor;

    try{
      audio.playbackRate = Math.max(0.25, Math.min(2.0, smoothedRate));
      // preservesPitch ã®å®‰å…¨è¨­å®š
      try {
        if('preservesPitch' in audio) audio.preservesPitch = true;
        else if('mozPreservesPitch' in audio) audio.mozPreservesPitch = true;
        else if('webkitPreservesPitch' in audio) audio.webkitPreservesPitch = true;
      } catch(e){}
    }catch(e){ console.warn('playbackRate set failed', e); }

    driftDisplay.textContent = `ã‚ºãƒ¬: ${diff.toFixed(3)} ç§’`;
    const absDiff = Math.abs(diff);
    driftDisplay.style.color = absDiff < 0.05 ? 'green' : (absDiff < 0.2 ? 'orange' : 'red');

    lastUpdateTime = now;
    rafId = requestAnimationFrame(loop);
  }
  rafId = requestAnimationFrame(loop);
}

function stopSyncLoop(fullStop = true){
  if(!isSyncing && fullStop) return;
  isSyncing = false;
  if(rafId) { cancelAnimationFrame(rafId); rafId = null; }
  // fullStop ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆã¯è§£é™¤
  if(fullStop){
    try {
      video.removeEventListener('seeking', ()=>{});
      video.removeEventListener('seeked', ()=>{});
      video.removeEventListener('ended', ()=>{});
    } catch(e){}
  }
}

/* ======= ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆå …ç‰¢åŒ–ï¼‰ ======= */
function isInputLike(el){
  if(!el) return false;
  const t = el.tagName ? el.tagName.toLowerCase() : '';
  return t === 'input' || t === 'textarea' || el.isContentEditable;
}
window.addEventListener('keydown', (e)=>{
  if(isInputLike(document.activeElement)) return;

  // preventAutoRepeat: é•·æŠ¼ã—ã§ã®å¯†ãªç™ºç«ã‚’æŠ‘ãˆãŸã„ãªã‚‰ã“ã“ã§å¯¾å‡¦ã§ãã‚‹ãŒ
  // ä»Šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ã§æ‰±ã†ï¼ˆå¿…è¦ãªã‚‰ throttle ã‚’è¿½åŠ ï¼‰
  if(e.code === 'Space' || e.key === ' '){
    e.preventDefault();
    if(video.paused) btnPlay.click();
    else btnPause.click();
  }
  else if(e.code === 'ArrowLeft'){
    e.preventDefault();
    video.currentTime = Math.max(0, (isFinite(video.currentTime)?video.currentTime:0) - 5);
    if(!video.paused) audio.currentTime = Math.max(0, (isFinite(video.currentTime)?video.currentTime:0) + audioDelay);
  }
  else if(e.code === 'ArrowRight'){
    e.preventDefault();
    video.currentTime = Math.min(isFinite(video.duration)?video.duration:Infinity, (isFinite(video.currentTime)?video.currentTime:0) + 5);
    if(!video.paused) audio.currentTime = Math.max(0, (isFinite(video.currentTime)?video.currentTime:0) + audioDelay);
  }
  else if(e.code === 'ArrowUp'){
    e.preventDefault();
    const newV = Math.min(100, parseInt(volumeSlider.value) + 5);
    volumeSlider.value = newV; applyVolume(newV); volumeValue.textContent = newV + '%';
  }
  else if(e.code === 'ArrowDown'){
    e.preventDefault();
    const newV = Math.max(0, parseInt(volumeSlider.value) - 5);
    volumeSlider.value = newV; applyVolume(newV); volumeValue.textContent = newV + '%';
  }
  else if(e.code === 'Comma' || e.key === '<' || e.key === ','){
    e.preventDefault();
    const s = Math.max(0.25, parseFloat(speedSlider.value) - 0.05);
    speedSlider.value = s.toFixed(2); speedSlider.dispatchEvent(new Event('input'));
  }
  else if(e.code === 'Period' || e.key === '>' || e.key === '.'){
    e.preventDefault();
    const s = Math.min(2.0, parseFloat(speedSlider.value) + 0.05);
    speedSlider.value = s.toFixed(2); speedSlider.dispatchEvent(new Event('input'));
  }
});

/* ======= ã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¨ãƒ©ãƒ¼ / å†ç”Ÿãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ======= */
video.addEventListener('error', ()=> showInfo('å‹•ç”»ã®å†ç”Ÿã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆURL/CORS ã‚’ç¢ºèªï¼‰', true));
audio.addEventListener('error', ()=> showInfo('éŸ³å£°ã®å†ç”Ÿã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆURL/CORS ã‚’ç¢ºèªï¼‰', true));
video.addEventListener('play', ()=> { if(audio.paused) try{ audio.play().catch(()=>{}); }catch(e){} });
video.addEventListener('pause', ()=> { if(!audio.paused) audio.pause(); });

/* å†ç”ŸçŠ¶æ…‹ã®è¦–è¦šçš„/ARIAæ›´æ–° */
video.addEventListener('play', ()=> { btnPlay.setAttribute('aria-pressed', 'true'); btnPause.setAttribute('aria-pressed', 'false'); });
video.addEventListener('pause', ()=> { btnPlay.setAttribute('aria-pressed', 'false'); btnPause.setAttribute('aria-pressed', 'true'); });

/* ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— */
window.addEventListener('beforeunload', ()=> {
  try { if(audioCtx) { audioCtx.close(); audioCtx = null; } } catch(e){}
  revokeCurrentObjectURL();
});

/* åˆæœŸè¡¨ç¤º */
delayValue.textContent = parseFloat(delaySlider.value).toFixed(2);
volumeValue.textContent = volumeSlider.value + '%';
speedValue.textContent = parseFloat(speedSlider.value).toFixed(2) + 'x';
strengthValue.textContent = parseFloat(strengthSlider.value).toFixed(2);
showInfo('æº–å‚™å®Œäº†ã€‚æ“ä½œæ–¹æ³•ã¯ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚');

</script>
</body>
</html>
